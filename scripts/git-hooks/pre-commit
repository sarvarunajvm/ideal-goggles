#!/bin/bash

# Pre-commit hook: Run linters and prevent debug code from being committed

set -e

echo "üîç Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Separate frontend and backend files
FRONTEND_FILES=$(echo "$STAGED_FILES" | grep -E '^frontend/src/.*\.(ts|tsx|js|jsx)$' || true)
BACKEND_FILES=$(echo "$STAGED_FILES" | grep -E '^backend/.*\.py$' || true)

ERRORS=0

# ============================================================================
# Frontend Checks
# ============================================================================
if [ -n "$FRONTEND_FILES" ]; then
  echo ""
  echo "üì¶ Checking frontend files..."

  # Check for console.log statements
  echo "  üîç Checking for console.log statements..."
  CONSOLE_LOGS=$(echo "$FRONTEND_FILES" | xargs grep -n "console\.log(" 2>/dev/null || true)

  if [ -n "$CONSOLE_LOGS" ]; then
    echo "  ‚ùå Found console.log statements:"
    echo "$CONSOLE_LOGS" | while read -r line; do
      echo "     $line"
    done
    echo ""
    echo "  üí° Use the logger utility instead: import { logger } from '@/utils/logger'"
    echo "  üí° Or use console.error/console.warn for legitimate logging"
    ERRORS=$((ERRORS + 1))
  else
    echo "  ‚úÖ No console.log statements found"
  fi

  # Check for debugger statements
  echo "  üîç Checking for debugger statements..."
  DEBUGGERS=$(echo "$FRONTEND_FILES" | xargs grep -n "^\s*debugger" 2>/dev/null || true)

  if [ -n "$DEBUGGERS" ]; then
    echo "  ‚ùå Found debugger statements:"
    echo "$DEBUGGERS" | while read -r line; do
      echo "     $line"
    done
    ERRORS=$((ERRORS + 1))
  else
    echo "  ‚úÖ No debugger statements found"
  fi

  # Run ESLint on staged files
  echo "  üîß Running ESLint..."
  if command -v pnpm &> /dev/null; then
    if ! echo "$FRONTEND_FILES" | xargs pnpm exec eslint -c frontend/eslint.config.mjs 2>&1 | grep -v "File ignored"; then
      echo "  ‚ùå ESLint found issues"
      ERRORS=$((ERRORS + 1))
    else
      echo "  ‚úÖ ESLint passed"
    fi
  else
    echo "  ‚ö†Ô∏è  pnpm not found, skipping ESLint"
  fi

  # TypeScript type checking (only if tsconfig exists)
  if [ -f "frontend/tsconfig.json" ]; then
    echo "  üîß Running TypeScript type check..."
    if pnpm run typecheck:frontend > /dev/null 2>&1; then
      echo "  ‚úÖ TypeScript type check passed"
    else
      echo "  ‚ùå TypeScript type check failed"
      echo "  üí° Run: pnpm run typecheck:frontend"
      ERRORS=$((ERRORS + 1))
    fi
  fi
fi

# ============================================================================
# Backend Checks
# ============================================================================
if [ -n "$BACKEND_FILES" ]; then
  echo ""
  echo "üêç Checking backend files..."

  # Check for print statements (should use logger)
  echo "  üîç Checking for print() statements..."
  PRINTS=$(echo "$BACKEND_FILES" | xargs grep -n "^\s*print(" 2>/dev/null || true)

  if [ -n "$PRINTS" ]; then
    echo "  ‚ö†Ô∏è  Found print() statements (use logger instead):"
    echo "$PRINTS" | while read -r line; do
      echo "     $line"
    done
    echo "  üí° Use: from src.core.logging_config import get_logger"
    # This is a warning, not an error - don't increment ERRORS
  fi

  # Check for breakpoint() or pdb
  echo "  üîç Checking for debugger statements..."
  DEBUGGERS=$(echo "$BACKEND_FILES" | xargs grep -nE "(breakpoint\(\)|import pdb|pdb\.set_trace)" 2>/dev/null || true)

  if [ -n "$DEBUGGERS" ]; then
    echo "  ‚ùå Found debugger statements:"
    echo "$DEBUGGERS" | while read -r line; do
      echo "     $line"
    done
    ERRORS=$((ERRORS + 1))
  else
    echo "  ‚úÖ No debugger statements found"
  fi

  # Run backend linting via pnpm
  echo "  üîß Running backend linter (Ruff)..."
  if command -v pnpm &> /dev/null; then
    if pnpm run backend:lint > /dev/null 2>&1; then
      echo "  ‚úÖ Backend linting passed"
    else
      echo "  ‚ùå Backend linting failed"
      echo "  üí° Run: pnpm run backend:lint"
      ERRORS=$((ERRORS + 1))
    fi
  else
    echo "  ‚ö†Ô∏è  pnpm not found, skipping backend linting"
  fi
fi

# ============================================================================
# Version Consistency Check
# ============================================================================
echo ""
echo "üî¢ Checking version consistency..."
PKG_VERSION=$(node -p "require('./package.json').version")
MAIN_PY_VERSION=$(grep -E 'version\s*=\s*"' backend/src/main.py | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
PYPROJECT_VERSION=$(grep -E '^version\s*=\s*"' backend/pyproject.toml | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

if [ "$PKG_VERSION" != "$MAIN_PY_VERSION" ] || [ "$PKG_VERSION" != "$PYPROJECT_VERSION" ]; then
  echo "  ‚ùå Version mismatch detected:"
  echo "     package.json:           $PKG_VERSION"
  echo "     backend/pyproject.toml: $PYPROJECT_VERSION"
  echo "     backend/src/main.py:    $MAIN_PY_VERSION"
  echo ""
  echo "  üí° Run: node scripts/update-version.js $PKG_VERSION"
  ERRORS=$((ERRORS + 1))
else
  echo "  ‚úÖ All versions synchronized: $PKG_VERSION"
fi

# ============================================================================
# Summary
# ============================================================================
echo ""
if [ $ERRORS -gt 0 ]; then
  echo "‚ùå Pre-commit checks failed with $ERRORS error(s)"
  echo ""
  echo "üí° Tips:"
  echo "   - Remove console.log and use logger instead"
  echo "   - Remove debugger statements"
  echo "   - Fix linting errors before committing"
  echo "   - Run 'pnpm run typecheck:frontend' to check TypeScript"
  echo "   - Run 'pnpm run backend:lint' to check Python"
  echo ""
  echo "üîß To skip this hook (not recommended): git commit --no-verify"
  exit 1
else
  echo "‚úÖ All pre-commit checks passed!"
  exit 0
fi
